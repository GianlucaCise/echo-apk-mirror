name: Changelog

on:
  release:
    types: [published]
  workflow_dispatch:

jobs:
  changelog:
    name: ðŸ“ Create Changelog
    runs-on: ubuntu-latest
    
    steps:
      - name: Get current release tag
        id: tag
        run: |
          if [ "${{ github.event_name }}" == "release" ]; then
            TAG="${{ github.event.release.tag_name }}"
          else
            TAG=$(curl -s https://api.github.com/repos/${{ github.repository }}/releases/latest | jq -r '.tag_name')
          fi
          
          echo "current_tag=${TAG}" >> $GITHUB_OUTPUT
          echo "Current tag: ${TAG}"
      
      - name: Generate simple changelog
        run: |
          TAG="${{ steps.tag.outputs.current_tag }}"
          DATE=$(date -u +"%Y-%m-%d")
          
          # Crea il changelog
          echo "# Changelog - ${TAG}" > CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "**Release Date:** ${DATE}" >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "## What's New" >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "This is an automated build of Echo APK." >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "### Downloads" >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "- [echo-${TAG}.apk](https://github.com/${{ github.repository }}/releases/download/${TAG}/echo-${TAG}.apk)" >> CHANGELOG.md
          echo "- [echo-latest.apk](https://github.com/${{ github.repository }}/releases/download/${TAG}/echo-latest.apk)" >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "### Links" >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "- [Official Echo Repository](https://github.com/brahmkshatriya/echo)" >> CHANGELOG.md
          echo "- [All Releases](https://github.com/${{ github.repository }}/releases)" >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "---" >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "*Automatically generated on ${DATE}*" >> CHANGELOG.md
          
          cat CHANGELOG.md
      
      - name: Upload changelog
        uses: actions/upload-artifact@v4
        with:
          name: changelog
          path: CHANGELOG.md
          retention-days: 30
      
      - name: Add to summary
        run: |
          echo "## ðŸ“‹ Changelog Created" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          cat CHANGELOG.md >> $GITHUB_STEP_SUMMARY
